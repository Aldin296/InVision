@page "/kanbanBoard/{boardId}"
@using InVision.Data
@using InVision.Pages
@inject KBoardService service
@inject DialogService DialogService
@inject Blazored.LocalStorage.ILocalStorageService localstore


<h1>@board.Name</h1>
<div class="row">
	<div class="col">
		<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid #AA4A44;  border-bottom: 2px solid #AA4A44">
			<RadzenText TextStyle="TextStyle.H6">
				<RadzenRow>
					<RadzenColumn Size="10">
						<strong>To Do</strong>
					</RadzenColumn>
					<RadzenColumn Size="2">
						<RadzenIcon @onclick="()=>OnAddItem(todo)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
					</RadzenColumn>
				</RadzenRow>
			</RadzenText>
		</RadzenCard>
		<Dropzone Items="MyFirstList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(todo, tdi))" Class="h-100">
			<ChildContent>
				<div class="card" style="border-left: 6px solid #AA4A44; border-color: #AA4A44; border-radius: 0px; max-width: 100%">
					<div class="card-body">
						<div style="width: 325px">
							<RadzenText contenteditable="true" style="white-space: pre-wrap;">
								<strong>@context.Title </strong>
							</RadzenText>
						</div>
						<RadzenRow>
							<RadzenColumn Size="12">
								<RadzenTextArea Style="width: 100%" Value="@context.Description"></RadzenTextArea>
							</RadzenColumn>
						</RadzenRow>
					</div>
				</div>
			</ChildContent>
			<Footer>
			</Footer>
		</Dropzone>
	</div>

	<div class="col">
		<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid orange;  border-bottom: 2px solid orange">
			<RadzenText TextStyle="TextStyle.H6">
				<RadzenRow>
					<RadzenColumn Size="10">
						<strong>In Progress</strong>
					</RadzenColumn>
					<RadzenColumn Size="2">
						<RadzenIcon @onclick="()=>OnAddItem(inProgress)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
					</RadzenColumn>
				</RadzenRow>
			</RadzenText>
		</RadzenCard>
		<Dropzone Items="MySecondList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(inProgress, tdi))" Class="h-100" Id="Progress">
			<ChildContent>
				<div class="card" style="border-left: 6px solid orange; border-color: orange; border-radius: 0px; max-width:100%">
					<div class="card-body">
						<div style="width: 325px">
							<RadzenText contenteditable="true" style="white-space: pre-wrap;">
								<strong>@context.Title </strong>
							</RadzenText>
						</div>
						<RadzenRow>
							<RadzenColumn Size="12">
								<RadzenTextArea Style="width: 100%" Value="@context.Description"></RadzenTextArea>
							</RadzenColumn>
						</RadzenRow>
					</div>
				</div>
			</ChildContent>
			<Footer>
			</Footer>
		</Dropzone>
	</div>

	<div class="col">
		<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid green;  border-bottom: 2px solid green">
			<RadzenText TextStyle="TextStyle.H6">
				<RadzenRow>
					<RadzenColumn Size="10">
						<strong>Done</strong>
					</RadzenColumn>
					<RadzenColumn Size="2">
						<RadzenIcon @onclick="()=>OnAddItem(done)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
					</RadzenColumn>
				</RadzenRow>
			</RadzenText>
		</RadzenCard>
		<Dropzone Items="MyThirdList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(done, tdi))" Class="h-100" Id="done">
			<div class="card" style="border-left: 6px solid green; border-color: green; border-radius: 0px; max-width:100%">
				<div class="card-body">
					<div style="width: 325px">
						<RadzenText contenteditable="true" style="white-space: pre-wrap;">
							<strong>@context.Title </strong>
						</RadzenText>
					</div>
					<RadzenRow>
						<RadzenColumn Size="12">
							<RadzenTextArea Style="width: 100%" Value="@context.Description"></RadzenTextArea>
						</RadzenColumn>
					</RadzenRow>
				</div>
			</div>
		</Dropzone>
	</div>
</div>


@code {
	[Parameter]
	public string boardId { get; set; }

	private KBoard board = new KBoard();
	private List<KBoard> boards = new List<KBoard>();

	public List<TodoItem> MyFirstList = new List<TodoItem>();
	public List<TodoItem> MySecondList = new List<TodoItem>();
	public List<TodoItem> MyThirdList = new List<TodoItem>();

	public string todo = "ToDo";
	public string inProgress = "InProgress";
	public string done = "Done";


	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		
		string userId = await localstore.GetItemAsync<string>("UserId");
		boards = await Task.Run(() => service.GetAllKBoardsAsync(userId));

		board = boards.Where(board => board.Id == boardId).FirstOrDefault();
		//board = service.GetBoardById(boardId);

		List<TodoItem>? listOfItems = board.Items;

		foreach (TodoItem item in listOfItems)
		{
			if (item.State == 0)
			{
				MyFirstList.Add(item);
			}
			if (item.State == 1)
			{
				MySecondList.Add(item);
			}
			if (item.State == 2)
			{
				MyThirdList.Add(item);
			}
		}
		if (firstRender)
		{
			await InvokeAsync(StateHasChanged);
		}

	}

	public async void OnAddItem(string dropzone)
	{
		TodoItem newitem = await DialogService.OpenAsync<AddToDoItemPage>("Add Task");
		if (newitem != null)
		{
			if (dropzone == "ToDo")
			{
				newitem.State = 0;
				MyFirstList.Add(newitem);
			}
			if (dropzone == "InProgress")
			{
				newitem.State = 1;
				MySecondList.Add(newitem);
			}
			if (dropzone == "Done")
			{
				newitem.State = 2;
				MyThirdList.Add(newitem);
			}
		}

		StateHasChanged();
	}


	public async void OnDeleteitem(string dropzone, TodoItem item)
	{
		var confirmationResult = await this.DialogService.Confirm("Are you sure?", "Dialog Title", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
		if (confirmationResult == true)
		{
			if (dropzone == "ToDo")
			{
				MyFirstList.Remove(item);
			}
			if (dropzone == "InProgress")
			{
				MySecondList.Remove(item);
			}
			if (dropzone == "Done")
			{
				MyThirdList.Remove(item);
			}
		}
		StateHasChanged();
	}

	public async void OnEditItem(TodoItem item)
	{

	}

	public void Itemdropcall(string dropzoneId, TodoItem item)
	{
		Console.WriteLine(dropzoneId);
		if (dropzoneId == "ToDo")
		{
			item.State = 0;
		}
		if (dropzoneId == "InProgress")
		{
			item.State = 1;
		}
		if (dropzoneId == "Done")
		{
			item.State = 2;
		}
	}
}
