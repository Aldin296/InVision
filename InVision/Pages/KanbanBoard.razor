@page "/kanbanBoard/{boardId}"
@using InVision.Data
@using InVision.Pages
@inject KBoardService service
@inject DialogService DialogService
@inject Blazored.LocalStorage.ILocalStorageService localstore


	<h1>@board.Name</h1>
	<div class="row">
		<div class="col">
			<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid #AA4A44;  border-bottom: 2px solid #AA4A44">
				<RadzenText TextStyle="TextStyle.H6">
					<RadzenRow>
						<RadzenColumn Size="10">
							<strong>To Do</strong>
						</RadzenColumn>
						<RadzenColumn Size="2">
							<RadzenIcon @onclick="()=>OnAddItem(todo)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
						</RadzenColumn>
					</RadzenRow>
				</RadzenText>
			</RadzenCard>
			<br>
			<Dropzone Items="MyFirstList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(todo, tdi))" Class="h-100">
				<ChildContent>
					<div class="card" style="border-left: 6px solid #AA4A44; border-color: #AA4A44; border-radius: 0px; max-width: 100%">
						<div class="card-body">
							<RadzenText contenteditable="true">
								<strong>@context.Title </strong>
							</RadzenText>
							<RadzenRow>
								<RadzenColumn Size="10">
									<RadzenTextArea contenteditable="true">@context.Description</RadzenTextArea>
									<p contenteditable="true">@context.Description</p>
								</RadzenColumn>
								<RadzenColumn Size="2">
									<RadzenIcon @onclick="()=>OnDeleteitem(todo,context)" Icon="delete" Style="cursor: pointer;" class="delete-todoitem-icon"></RadzenIcon>
								</RadzenColumn>
							</RadzenRow>
						</div>
					</div>
				</ChildContent>
				<Footer>
				</Footer>
			</Dropzone>
		</div>

		<div class="col">
			<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid orange;  border-bottom: 2px solid orange">
				<RadzenText TextStyle="TextStyle.H6">
					<RadzenRow>
						<RadzenColumn Size="10">
							<strong>In Progress</strong>
						</RadzenColumn>
						<RadzenColumn Size="2">
							<RadzenIcon @onclick="()=>OnAddItem(inProgress)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
						</RadzenColumn>
					</RadzenRow>
				</RadzenText>
			</RadzenCard>

			<Dropzone Items="MySecondList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(inProgress, tdi))" Class="h-100" Id="Progress">
				<ChildContent>
					<div class="card" style="border-left: 6px solid orange; border-color: orange; border-radius: 0px; max-width:100%">
						<div class="card-body">
							<RadzenText contenteditable="true">
								<strong>@context.Title </strong>
							</RadzenText>
							<RadzenRow>
								<RadzenColumn Size="10">
									<p contenteditable="true">@context.Description</p>
								</RadzenColumn>
								<RadzenColumn Size="2">
									<RadzenIcon @onclick="()=>OnDeleteitem(inProgress,context)" Icon="delete" Style="cursor: pointer;"></RadzenIcon>
								</RadzenColumn>
							</RadzenRow>
						</div>
					</div>
				</ChildContent>
				<Footer>
				</Footer>
			</Dropzone>
		</div>

		<div class="col">
			<RadzenCard style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-left: 6px solid green;  border-bottom: 2px solid green">
				<RadzenText TextStyle="TextStyle.H6">
					<RadzenRow>
						<RadzenColumn Size="10">
							<strong>Done</strong>
						</RadzenColumn>
						<RadzenColumn Size="2">
							<RadzenIcon @onclick="()=>OnAddItem(done)" Icon="add_circle_outline" Style="cursor: pointer;" class="add-todoitem-icon"></RadzenIcon>
						</RadzenColumn>
					</RadzenRow>
				</RadzenText>
			</RadzenCard>
			<Dropzone Items="MyThirdList" TItem="TodoItem" OnItemDrop="@((tdi)=>Itemdropcall(done, tdi))" Class="h-100" Id="done">
				<div class="card" style="border-left: 6px solid green; border-color: green; border-radius: 0px; max-width:100%">
					<div class="card-body">
						<RadzenText contenteditable="true">
							<strong>@context.Title </strong>
						</RadzenText>
						<RadzenRow>
							<RadzenColumn Size="10">
								<p @onchange="()=>OnEditItem(context)" contenteditable="true">@context.Description</p>
							</RadzenColumn>
							<RadzenColumn Size="2">
								<RadzenIcon @onclick="()=>OnDeleteitem(done, context)" Icon=" delete" Style="cursor: pointer;"></RadzenIcon>
							</RadzenColumn>
						</RadzenRow>
					</div>
				</div>
			</Dropzone>
		</div>
	</div>


@code {
	[Parameter]
	public string boardId { get; set; }

	private KBoard board = new KBoard();
	private List<KBoard> boards = new List<KBoard>();

	public List<TodoItem> MyFirstList = new List<TodoItem>();
	public List<TodoItem> MySecondList = new List<TodoItem>();
	public List<TodoItem> MyThirdList = new List<TodoItem>();

	public string todo = "ToDo";
	public string inProgress = "InProgress";
	public string done = "Done";


	protected override async Task OnInitializedAsync()
	{
		string userId = await localstore.GetItemAsync<string>("UserId");
		boards = await Task.Run(() => service.GetAllKBoardsAsync(userId));

		board = boards.Where(board => board.Id == boardId).FirstOrDefault();
		//board = service.GetBoardById(boardId);

		List<TodoItem>? listOfItems = board.Items;

		foreach (TodoItem item in listOfItems)
		{
			if (item.state == 0)
			{
				MyFirstList.Add(item);
			}
			if (item.state == 1)
			{
				MySecondList.Add(item);
			}
			if (item.state == 2)
			{
				MyThirdList.Add(item);
			}
		}

	}

	public async void OnAddItem(string dropzone)
	{
		TodoItem newitem = await DialogService.OpenAsync<AddToDoItemPage>("Add Appointment");
		if (newitem != null)
		{
			if (dropzone == "ToDo")
			{
				newitem.state = 0;
				MyFirstList.Add(newitem);
			}
			if (dropzone == "InProgress")
			{
				newitem.state = 1;
				MySecondList.Add(newitem);
			}
			if (dropzone == "Done")
			{
				newitem.state = 2;
				MyThirdList.Add(newitem);
			}
		}

		StateHasChanged();
	}


	public async void OnDeleteitem(string dropzone, TodoItem item)
	{
		var confirmationResult = await this.DialogService.Confirm("Are you sure?", "Dialog Title", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
		if (confirmationResult == true)
		{
			if (dropzone == "ToDo")
			{
				MyFirstList.Remove(item);
			}
			if (dropzone == "InProgress")
			{
				MySecondList.Remove(item);
			}
			if (dropzone == "Done")
			{
				MyThirdList.Remove(item);
			}
		}
		StateHasChanged();
	}

	public async void OnEditItem(TodoItem item)
	{

	}

	public void Itemdropcall(string dropzoneId, TodoItem item)
	{
		Console.WriteLine(dropzoneId);
		if (dropzoneId == "ToDo")
		{
			item.state = 0;
		}
		if (dropzoneId == "InProgress")
		{
			item.state = 1;
		}
		if (dropzoneId == "Done")
		{
			item.state = 2;
		}
	}



}
